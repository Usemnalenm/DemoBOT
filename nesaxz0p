import telebot
import requests
from telebot import types

# ØªÙˆÙƒÙ† Ø§Ù„Ø¨ÙˆØª Ø§Ù„Ø®Ø§Øµ Ø¨Ùƒ
API_TOKEN = '7030188013:AAF5QESdUci5hjMkn6C4rc_EiPvnYh2F3V4'

# ØªÙ‡ÙŠØ¦Ø© Ø§Ù„Ø¨ÙˆØª
bot = telebot.TeleBot(API_TOKEN)

# Ø§Ù„Ù…ØªØºÙŠØ±Ø§Øª Ø§Ù„Ù…Ø¤Ù‚ØªØ© Ù„ØªØ®Ø²ÙŠÙ† Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…
user_data = {}  # ÙŠÙ…ÙƒÙ† Ø§Ø³ØªØ¨Ø¯Ø§Ù„Ù‡ Ø¨Ù‚Ø§Ø¹Ø¯Ø© Ø¨ÙŠØ§Ù†Ø§Øª ÙØ¹Ù„ÙŠØ©

# Ø§Ù„ØªØ¹Ø§Ù…Ù„ Ù…Ø¹ Ø£Ù…Ø± Ø§Ù„Ø¨Ø¯Ø¡
@bot.message_handler(commands=['start'])
def send_welcome(message):
    # Ø¥Ù†Ø´Ø§Ø¡ Ø²Ø± Ø§Ù„Ù…ØµØ¯Ø±
    markup = types.InlineKeyboardMarkup()
    source_button = types.InlineKeyboardButton(text="ğŸ“Œ Ø§Ù„Ù…ØµØ¯Ø±", url="https://t.me/difo100")
    markup.add(source_button)
    
    # Ø±Ø³Ø§Ù„Ø© Ø§Ù„ØªØ±Ø­ÙŠØ¨
    welcome_message = """
âœ¨ **Ù…Ø±Ø­Ø¨Ù‹Ø§ Ø¨Ùƒ ÙÙŠ Ø¨ÙˆØªÙ†Ø§!** âœ¨

ğŸ› ï¸ Ù†Ø­Ù† Ù‡Ù†Ø§ Ù„Ù…Ø³Ø§Ø¹Ø¯ØªÙƒ ÙÙŠ Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ø¨Ø§Ù‚Ø§Øª Ø§Ù„Ø¥Ù†ØªØ±Ù†Øª Ø¨ÙƒÙ„ Ø³Ù‡ÙˆÙ„Ø©.

ğŸ“ ÙŠØ±Ø¬Ù‰ Ø¥Ø±Ø³Ø§Ù„ Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ Ø§Ù„Ø®Ø§Øµ Ø¨Ùƒ Ù„Ù„Ø§Ø³ØªÙ…Ø±Ø§Ø± ÙÙŠ Ø§Ù„Ø¹Ù…Ù„ÙŠØ©.

ğŸš€ **Ø§ØªØ¨Ø¹ Ø§Ù„ØªØ¹Ù„ÙŠÙ…Ø§Øª Ù„Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ø£ÙØ¶Ù„ ØªØ¬Ø±Ø¨Ø©.**

Ø¥Ø°Ø§ ÙƒÙ†Øª Ø¨Ø­Ø§Ø¬Ø© Ø¥Ù„Ù‰ Ø£ÙŠ Ù…Ø³Ø§Ø¹Ø¯Ø©ØŒ Ù„Ø§ ØªØªØ±Ø¯Ø¯ ÙÙŠ Ø§Ù„ØªÙˆØ§ØµÙ„ Ù…Ø¹Ù†Ø§!

ğŸ’¬ **Ù„Ù…Ø²ÙŠØ¯ Ù…Ù† Ø§Ù„ØªÙØ§ØµÙŠÙ„ØŒ ÙŠØ±Ø¬Ù‰ Ø²ÙŠØ§Ø±Ø©:** [Ø§Ù„Ù…ØµØ¯Ø±](https://t.me/difo100)
    """
    bot.send_message(message.chat.id, welcome_message, reply_markup=markup, parse_mode='Markdown')

# Ø§Ù„ØªØ¹Ø§Ù…Ù„ Ù…Ø¹ Ø¥Ø¯Ø®Ø§Ù„ Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ
@bot.message_handler(func=lambda message: True)
def handle_phone_number(message):
    chat_id = message.chat.id
    num = message.text
    
    if chat_id in user_data and 'access_token' in user_data[chat_id]:
        bot.send_message(chat_id, 'Ù…Ø±Ø­Ø¨Ù‹Ø§ Ù…Ø¬Ø¯Ø¯Ù‹Ø§! Ø¬Ø§Ø±ÙŠ Ø¥Ø±Ø³Ø§Ù„ Ø·Ù„Ø¨ Ø§Ù„Ø¥Ù†ØªØ±Ù†Øª...')
        apply_internet_package(chat_id)
    else:
        # ØªØ®Ø²ÙŠÙ† Ø§Ù„Ø±Ù‚Ù… Ø§Ù„Ù…Ø¯Ø®Ù„
        user_data[chat_id] = {'phone_number': num}
        bot.reply_to(message, "ØªÙ… Ø§Ø³ØªÙ„Ø§Ù… Ø§Ù„Ø±Ù‚Ù…. Ø¬Ø§Ø±ÙŠ Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø·Ù„Ø¨ Ù„Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ø§Ù„ÙƒÙˆØ¯...")
        # Ø·Ù„Ø¨ Ø¥Ø±Ø³Ø§Ù„ OTP
        send_otp(chat_id, num)

# Ø¯Ø§Ù„Ø© Ø¥Ø±Ø³Ø§Ù„ OTP
def send_otp(chat_id, num):
    headers = {
        'Content-Type': 'application/x-www-form-urlencoded',
        'Host': 'ibiza.ooredoo.dz',
        'Connection': 'Keep-Alive',
        'User-Agent': 'okhttp/4.9.3',
    }

    data = {
        'client_id': 'ibiza-app',
        'grant_type': 'password',
        'mobile-number': num,
        'language': 'AR',
    }

    try:
        response = requests.post('https://ibiza.ooredoo.dz/auth/realms/ibiza/protocol/openid-connect/token', headers=headers, data=data)
        response.raise_for_status()

        if 'ROOGY' in response.text:
            bot.send_message(chat_id, 'ØªÙ… Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„ÙƒÙˆØ¯. Ù…Ù† ÙØ¶Ù„Ùƒ Ø£Ø¯Ø®Ù„ OTP:')
            bot.register_next_step_handler_by_chat_id(chat_id, handle_otp)
        else:
            bot.send_message(chat_id, 'ÙØ´Ù„ ÙÙŠ Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„ÙƒÙˆØ¯. Ø­Ø§ÙˆÙ„ Ù…Ø¬Ø¯Ø¯Ù‹Ø§.')

    except requests.RequestException as e:
        bot.send_message(chat_id, f'Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø§ØªØµØ§Ù„: {str(e)}')

# Ø§Ù„ØªØ¹Ø§Ù…Ù„ Ù…Ø¹ Ø¥Ø¯Ø®Ø§Ù„ OTP
def handle_otp(message):
    chat_id = message.chat.id
    otp = message.text
    num = user_data[chat_id]['phone_number']
    
    bot.send_message(chat_id, 'Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„ÙƒÙˆØ¯...')

    headers = {
        'Content-Type': 'application/x-www-form-urlencoded',
        'Host': 'ibiza.ooredoo.dz',
        'Connection': 'Keep-Alive',
        'User-Agent': 'okhttp',
    }

    data = {
        'client_id': 'ibiza-app',
        'otp': otp,
        'grant_type': 'password',
        'mobile-number': num,
        'language': 'AR',
    }

    try:
        response = requests.post('https://ibiza.ooredoo.dz/auth/realms/ibiza/protocol/openid-connect/token', headers=headers, data=data)
        response.raise_for_status()

        if response.status_code == 200 and 'access_token' in response.json():
            access_token = response.json()['access_token']
            user_data[chat_id]['access_token'] = access_token
            bot.send_message(chat_id, 'ØªÙ… ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø¨Ù†Ø¬Ø§Ø­. Ø¬Ø§Ø±ÙŠ Ø¥Ø±Ø³Ø§Ù„ Ø·Ù„Ø¨ Ø§Ù„Ø¥Ù†ØªØ±Ù†Øª...')
            apply_internet_package(chat_id)
        else:
            bot.send_message(chat_id, 'ÙØ´Ù„ ÙÙŠ Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„ÙƒÙˆØ¯. Ø­Ø§ÙˆÙ„ Ù…Ø¬Ø¯Ø¯Ù‹Ø§.')

    except requests.RequestException as e:
        bot.send_message(chat_id, f'Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø§ØªØµØ§Ù„: {str(e)}')

# Ø¯Ø§Ù„Ø© Ø·Ù„Ø¨ Ø¨Ø§Ù‚Ø© Ø§Ù„Ø¥Ù†ØªØ±Ù†Øª
def apply_internet_package(chat_id):
    access_token = user_data[chat_id]['access_token']
    
    url = 'https://ibiza.ooredoo.dz/api/v1/mobile-bff/users/mgm/info/apply'

    headers = {
        'Authorization': f'Bearer {access_token}',
        'language': 'AR',
        'request-id': 'ef69f4c6-2ead-4b93-95df-106ef37feefd',
        'flavour-type': 'gms',
        'Content-Type': 'application/json'
    }

    payload = {
        "mgmValue": "ABC"  # ÙŠØ¬Ø¨ ØªØºÙŠÙŠØ± Ù‡Ø°Ù‡ Ø§Ù„Ù‚ÙŠÙ…Ø© Ø¥Ø°Ø§ Ù„Ø²Ù… Ø§Ù„Ø£Ù…Ø±
    }

    try:
        response = requests.post(url, headers=headers, json=payload)
        response.raise_for_status()

        if 'EU1002' in response.text:
            bot.send_message(chat_id, 'ØªÙ… Ø¥Ø±Ø³Ø§Ù„ Ø¨Ø§Ù‚Ø© Ø§Ù„Ø¥Ù†ØªØ±Ù†Øª Ø¨Ù†Ø¬Ø§Ø­!')
        else:
            bot.send_message(chat_id, 'Ù„Ø¯ÙŠÙƒ Ø¨Ø§Ù‚Ø© ÙƒØ§ÙÙŠØ©. Ø­Ø§ÙˆÙ„ Ù„Ø§Ø­Ù‚Ù‹Ø§.')

    except requests.RequestException as e:
        bot.send_message(chat_id, f'Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø§ØªØµØ§Ù„: {str(e)}')

# Ø¨Ø¯Ø¡ Ø§Ù„Ø¨ÙˆØª
bot.polling()
